<!--
  ~
  ~  Copyright 2019 InfAI (CC SES)
  ~
  ~  Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  -->

<h2 mat-dialog-title>Device Type</h2>

<mat-dialog-content class="device-type-stepper-group">
    <mat-horizontal-stepper #stepper class="stepper-size">
        <mat-step [stepControl]="firstFormGroup">
            <form [formGroup]="firstFormGroup">
                <ng-template matStepLabel>Information</ng-template>
                <div class="form">
                    <mat-form-field class="full-width" color="accent">
                        <input matInput placeholder="Name" formControlName="nameCtrl" required>
                    </mat-form-field>
                    <mat-form-field class="full-width" color="accent">
                        <input matInput placeholder="Description" formControlName="descCtrl" required>
                    </mat-form-field>
                    <mat-form-field class="full-width" color="accent">
                        <input matInput placeholder="Image" formControlName="imgCtrl">
                    </mat-form-field>
                    <table class="full-width" cellspacing="0">
                        <!--section Device Class-->
                        <tr>
                            <td *ngIf="hideAddDeviceClass === false">
                                <mat-form-field class="full-width" color="accent">
                                    <mat-select placeholder="Device class" [compareWith]="compareId"
                                                formControlName="classCtrl" [required]="!deviceType.generated">
                                        <mat-option *ngFor="let deviceTypeClass of deviceTypeClasses"
                                                    [value]="deviceTypeClass">
                                            {{deviceTypeClass.name}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </td>
                            <td *ngIf="hideAddDeviceClass === false">
                                <button mat-icon-button class="mat-accent" (click)="hideDeviceClass(true)" [disabled]="deviceType.generated">
                                    <mat-icon matTooltip="create new device class">playlist_add</mat-icon>
                                </button>
                            </td>
                            <td *ngIf="hideAddDeviceClass === true">
                                <mat-form-field class="full-width" color="accent">
                                    <input (focus)="focusDeviceClass(true)" (focusout)="focusDeviceClass(false)" type="text" matInput placeholder="Please insert device class" [formControl]="deviceClassInputFormControl">
                                </mat-form-field>
                            </td>
                            <td *ngIf="hideAddDeviceClass === true">
                                <button *ngIf="!deviceClassInputFocus" mat-icon-button class="mat-accent" (click)="hideDeviceClass(false)">
                                    <mat-icon  matTooltip="return to list">undo</mat-icon>
                                </button>
                                <button *ngIf="deviceClassInputFocus" mat-icon-button [disabled]="deviceClassInputFormControl.value === ''" class="mat-accent" (click)="addDeviceClass()">
                                    <mat-icon  matTooltip="add device class">add</mat-icon>
                                </button>
                            </td>
                            <!--section Vendor-->
                            <td *ngIf="hideAddVendor === false">
                                <mat-form-field class="full-width" color="accent">
                                    <mat-select placeholder="Vendor" [compareWith]="compareId"
                                                formControlName="vendorCtrl" [required]="!deviceType.generated">
                                        <mat-option *ngFor="let deviceTypeVendor of deviceTypeVendors"
                                                    [value]="deviceTypeVendor">
                                            {{deviceTypeVendor.name}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </td>
                            <td *ngIf="hideAddVendor === false">
                                <button mat-icon-button class="mat-accent" (click)="hideVendor(true)" [disabled]="deviceType.generated">
                                    <mat-icon matTooltip="create new vendor">playlist_add</mat-icon>
                                </button>
                            </td>
                            <td *ngIf="hideAddVendor === true">
                                <mat-form-field class="full-width" color="accent">
                                    <input (focus)="focusVendor(true)" (focusout)="focusVendor(false)" type="text" matInput placeholder="Please insert vendor" [formControl]="vendorInputFormControl">
                                </mat-form-field>
                            </td>
                            <td *ngIf="hideAddVendor === true">
                                <button *ngIf="!vendorInputFocus" mat-icon-button class="mat-accent" (click)="hideVendor(false)">
                                    <mat-icon  matTooltip="return to list">undo</mat-icon>
                                </button>
                                <button *ngIf="vendorInputFocus" mat-icon-button [disabled]="vendorInputFormControl.value === ''" class="mat-accent" (click)="addVendor()">
                                    <mat-icon  matTooltip="add vendor">add</mat-icon>
                                </button>
                            </td>
                        </tr>
                    </table>
                    <mat-form-field class="full-width" color="accent">
                        <input [disabled]="true" matInput placeholder="Generated" [value]="deviceType.generated ? 'yes' : 'no'">
                    </mat-form-field>
                </div>
            </form>
        </mat-step>
        <mat-step [stepControl]="secondFormGroup">
            <form [formGroup]="secondFormGroup">
                <ng-template matStepLabel>Service</ng-template>
                <mat-accordion formArrayName="services" *ngIf="secondFormGroup.get('services')">
                    <mat-expansion-panel [formGroupName]="i" *ngFor="let control of secondFormGroup.get('services').controls; let i = index">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                Service {{control.value.name}}
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <mat-tab-group color="accent" headerPosition="above" dynamicHeight="true">
                            <mat-tab label="Information">
                                <div class="form">
                                    <mat-form-field class="full-width" color="accent">
                                        <input matInput placeholder="Name" formControlName="name" required>
                                    </mat-form-field>
                                    <mat-form-field class="full-width" color="accent">
                                        <input matInput placeholder="Description" formControlName="description" required>
                                    </mat-form-field>
                                    <mat-form-field class="full-width" color="accent">
                                        <input matInput placeholder="URL" formControlName="url" required>
                                    </mat-form-field>
                                    <table class="full-width" cellspacing="0">
                                        <tr>
                                            <td>
                                                <mat-form-field class="full-width" color="accent">
                                                    <mat-select placeholder="Service type"
                                                                formControlName="service_type"
                                                                required>
                                                        <mat-option
                                                                *ngFor="let deviceTypeServiceType of deviceTypeServiceTypes"
                                                                [value]="deviceTypeServiceType.url">
                                                            {{deviceTypeServiceType.shortText}}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            </td>
                                            <td>
                                                <mat-form-field class="full-width" color="accent">
                                                    <mat-select placeholder="Protocol" [compareWith]="compareId"
                                                                formControlName="protocol"
                                                                required>
                                                        <mat-option
                                                                *ngFor="let deviceTypeProtocol of deviceTypeProtocols"
                                                                [value]="deviceTypeProtocol">
                                                            {{deviceTypeProtocol.name}}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </mat-tab>

                            <mat-tab label="{{tab.label}}" disabled="{{control.value.protocol === ''}}"
                                     formArrayName="{{tab.formArrayName}}"
                                     *ngFor="let tab of [{label: 'Input', formArrayName: 'input'},{label: 'Output', formArrayName: 'output'}]">
                                <div [formGroupName]="i"
                                     *ngFor="let control of control.get(tab.formArrayName).controls;  let i = index">
                                    <div fxLayout="row" fxLayoutAlign="start center" >
                                        <button mat-icon-button class="mat-accent"
                                                (click)="expand(control)">
                                            <mat-icon>{{control.value.show ? 'expand_less' : 'expand_more'}}</mat-icon>
                                        </button>
                                        <div>{{control.value.msg_segment.name}}</div>
                                    </div>

                                    <div fxLayout="row" [fxShow]="control.value.show === true">
                                        <div fxFlex>
                                            <mat-form-field class="full-width" color="accent">
                                                <input matInput placeholder="Name" formControlName="name">
                                            </mat-form-field>
                                            <table class="full-width" cellspacing="0">
                                                <tr>
                                                    <td>
                                                        <mat-form-field class="full-width" color="accent">
                                                            <mat-select placeholder="Format" formControlName="format">
                                                                <mat-option>-- None --</mat-option>
                                                                <mat-option
                                                                        *ngFor="let deviceTypeFormat of deviceTypeFormats"
                                                                        [value]="deviceTypeFormat.id">
                                                                    {{deviceTypeFormat.name}}
                                                                </mat-option>
                                                            </mat-select>
                                                        </mat-form-field>
                                                    </td>
                                                    <td>
                                                        <mat-form-field class="full-width" color="accent">
                                                            <mat-select placeholder="Value type"
                                                                        [compareWith]="compareId"
                                                                        formControlName="type">
                                                                <mat-option>-- None --</mat-option>
                                                                <mat-option
                                                                        *ngFor="let deviceTypeValueType of deviceTypeValueTypes"
                                                                        [value]="deviceTypeValueType">
                                                                    {{deviceTypeValueType.name}}
                                                                </mat-option>
                                                            </mat-select>
                                                        </mat-form-field>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                        <mat-divider vertical="true" class="divider-margin"></mat-divider>
                                        <div fxFlex [ngSwitch]="checkIfAssignmentExists(control.value)">
                                            <div *ngSwitchCase="false">
                                                No preview possible.
                                            </div>
                                            <!-- WARNING!!! DONT REFORMAT LINE BELOW-->
                                            <!-- PreviewFormat will change-->
                                            <pre class="word-wrap" *ngSwitchCase="true">{{control.value | previewFormat | async }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </mat-tab>

                        </mat-tab-group>
                        <div fxLayoutAlign="end center">
                            <button (click)="deleteService(control.value)" mat-icon-button class="mat-accent"
                                    matTooltip="delete service" [disabled]="deviceType.generated">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>

                    </mat-expansion-panel>
                </mat-accordion>
                <div class="button-margin" fxLayoutAlign="center center" *ngIf="!deviceType.generated">
                    <button class="mat-raised-button color-accent" (click)="addService()">ADD Service</button>
                </div>
            </form>
        </mat-step>
        <mat-step>
            <ng-template matStepLabel>Save</ng-template>
            <div *ngIf="!disableSave">You are now done.</div>
            <div *ngIf="disableSave">Can't save, please fix errors.</div>
            <div>
                <div fxFlex></div>
                <button class="mat-raised-button color-accent button-save-margin" (click)="close()">Cancel</button>
                <button class="mat-raised-button mat-accent button-save-margin" [disabled]="disableSave" (click)="save()">Save</button>
            </div>
        </mat-step>
    </mat-horizontal-stepper>
</mat-dialog-content>


